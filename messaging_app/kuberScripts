#!/bin/bash

# kurbeScript - Kubernetes Cluster Setup and Verification Script
# This script starts a Kubernetes cluster using minikube and verifies its operation

set -e  # Exit on any error

echo "================================================"
echo "Kubernetes Cluster Setup Script"
echo "================================================"
echo ""

# Check if minikube is installed
echo "[1/5] Checking if minikube is installed..."
if ! command -v minikube &> /dev/null; then
    echo "ERROR: minikube is not installed!"
    echo "Please install minikube first:"
    echo "  - Linux: curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 && sudo install minikube-linux-amd64 /usr/local/bin/minikube"
    echo "  - macOS: brew install minikube"
    echo "  - Windows: choco install minikube"
    exit 1
else
    echo "✓ minikube is installed: $(minikube version --short)"
fi

# Check if kubectl is installed
echo ""
echo "[2/5] Checking if kubectl is installed..."
if ! command -v kubectl &> /dev/null; then
    echo "ERROR: kubectl is not installed!"
    echo "Please install kubectl first."
    exit 1
else
    echo "✓ kubectl is installed: $(kubectl version --client --short 2>/dev/null || kubectl version --client)"
fi

# Start minikube cluster
echo ""
echo "[3/5] Starting Kubernetes cluster with minikube..."
if minikube status &> /dev/null; then
    echo "✓ Minikube cluster is already running"
else
    echo "Starting new minikube cluster..."
    minikube start --driver=docker --cpus=2 --memory=2048
    echo "✓ Minikube cluster started successfully"
fi

# Verify cluster is running
echo ""
echo "[4/5] Verifying cluster status with kubectl cluster-info..."
echo "----------------------------------------"
kubectl cluster-info
echo "----------------------------------------"
echo "✓ Cluster is running and accessible"

# Retrieve available pods
echo ""
echo "[5/5] Retrieving available pods across all namespaces..."
echo "----------------------------------------"
kubectl get pods --all-namespaces
echo "----------------------------------------"

# Additional cluster information
echo ""
echo "================================================"
echo "Cluster Setup Complete!"
echo "================================================"
echo ""
echo "Cluster Details:"
echo "  - Minikube Status: $(minikube status -o json | grep -o '"Host":"[^"]*"' | cut -d'"' -f4)"
echo "  - Kubernetes Version: $(kubectl version --short 2>/dev/null | grep Server || kubectl version -o json | grep gitVersion)"
echo "  - Current Context: $(kubectl config current-context)"
echo ""
echo "Useful Commands:"
echo "  - View cluster info: kubectl cluster-info"
echo "  - View all pods: kubectl get pods --all-namespaces"
echo "  - View nodes: kubectl get nodes"
echo "  - Access dashboard: minikube dashboard"
echo "  - Stop cluster: minikube stop"
echo "  - Delete cluster: minikube delete"
echo ""
echo "================================================"